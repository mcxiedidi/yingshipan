# 触发工作流的条件：手动触发（workflow_dispatch）或推送了 tag（例如 v1.0.0）
on:
  workflow_dispatch:
  push:
    tags:
      - '*'  # 匹配所有 tag，例如 v1.0.0

# 定义多个“任务”（jobs），每个任务表示构建一个平台的应用
jobs:
  android: # 构建 Android 应用
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4  # 设置 Java 环境（Android 编译需要）
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: subosito/flutter-action@v2
      - run: flutter pub get
      - run: flutter build apk --target-platform android-arm64  # 构建 64 位 Android 安装包
      - run: cp build/app/outputs/flutter-apk/app-release.apk android.apk
      - uses: softprops/action-gh-release@v2
        with:
          files: android.apk  # 上传 APK 文件
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: true
        env:
          # 使用自定义的 PAT 替换默认的 GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

  ios: # 构建 iOS 应用（需要 macOS 系统）
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: subosito/flutter-action@v2
      - run: flutter pub get
      - run: flutter build ios --release --no-codesign  # 构建 iOS 应用，但不签名（用于测试）
      - run: tar -czvf ios.tar.gz -C build/ios/iphoneos Runner.app  # 压缩打包
      - uses: softprops/action-gh-release@v2
        with:
          files: ios.tar.gz
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}
          prerelease: true
        env:
          # 使用自定义的 PAT 替换默认的 GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
